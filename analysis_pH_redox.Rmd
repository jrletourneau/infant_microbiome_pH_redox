---
title: "Infant fecal pH/redox analysis"
output: html_notebook
---

# Load libraries
```{r}
# Plotting
library(tidyverse)
#library(RColorBrewer)
library(ggtext)
library(ggsignif)
library(cowplot)

# Stats
library(phyloseq)
library(lme4)
library(lmerTest)
library(vegan)
library(ALDEx2)

theme_set(theme_bw() +
            theme(axis.text = element_text(color = "black"),
                  axis.ticks = element_line(color = "black"),
                  plot.title = element_text(hjust = 0.5)))

set.seed(123)


```

# Load and clean up data 
```{r}
# pH and redox with clinical data
## See data/variable_descriptions_for_fecal_pH_final.xlsx for explanations of variables
pH_redox <- read.csv("data/fecal_pH_final.csv")

# SCFA data by GC
## Isobutyrate, isovalerate, and valerate were not detected for any samples
## Two samples have been omitted where nothing was detected
## All values have been multiplied by 10 (dilution factor) and are in mM
## Where values were NA/0, they have been replaced with a pseudocount equal to the lowest value observed for that SCFA
gc <- read.csv("data/nicu_gc_cleaned.csv")

# Combine
pH_redox <- pH_redox %>%
  left_join(gc) %>%
  relocate(acetate:total, .after = redox)


```

## 16S
```{r}
# Load phyloseq object, omitting samples with < 5000 reads
## This version used to calculate diversity
ps <- readRDS("data/phyloseq.rds") %>%
  prune_samples(sample_sums(.) >= 5000, .)
# 95 taxa by 77 samples (none removed by filter)

# Omit low abundance taxa for differential abundance analysis
ps_filt <- ps %>%
  filter_taxa(function(x) sum(x > 3) > 0.1*length(x), TRUE)
# Reduces to 23 taxa (wow!)

```

# pH and redox
## Analyze pH and redox in context of clinical data - birth stats
```{r}
# Summarize pH and redox within infants
## Need to account for NA values in some cases
pH_redox_summary <- pH_redox %>%
  group_by(Subject, BGA, bw, matabx) %>%
  summarize(mean_pH = mean(pH, na.rm = T),
            se_pH = sd(pH, na.rm = T)/sqrt(length(which(!is.na(pH)))),
            mean_redox = mean(redox, na.rm = T),
            se_redox = sd(redox, na.rm = T)/sqrt(length(which(!is.na(redox)))))

# Linear models - pH
pH_redox %>%
  lmer(pH ~ matabx + (1|Subject), data = .) %>%
  summary()
# BGA p = 0.016
# bw p = 0.0046
# matabx p = 0.76

# Examine birth stats
pH_BGA_plot <- ggplot(pH_redox, aes(x = BGA, y = pH, color = Subject)) +
  geom_point() +
  geom_errorbar(data = pH_redox_summary, aes(x = BGA, ymin = mean_pH, ymax = mean_pH, color = Subject),
                width = 0.5, inherit.aes = F) +
  geom_errorbar(data = pH_redox_summary, aes(x = BGA, ymin = mean_pH - se_pH,
                                             ymax = mean_pH + se_pH, color = Subject),
                width = 0.25, inherit.aes = F) +
  labs(x = "Birth gestational age (weeks)", y = "Fecal pH", color = "Participant") +
  geom_textbox(data = data.frame(x=33, y = 7, label = "LMM<br>*p* = 0.016"),
               aes(x, y, label = label), halign = 0.5, fill = NA, box.colour = NA,
               box.padding = grid::unit(rep(0, 4), "pt"), inherit.aes = F)

pH_bw_plot <- ggplot(pH_redox, aes(x = bw, y = pH, color = Subject)) +
  geom_point() +
  geom_errorbar(data = pH_redox_summary, aes(x = bw, ymin = mean_pH, ymax = mean_pH, color = Subject),
                width = 40, inherit.aes = F) +
  geom_errorbar(data = pH_redox_summary, aes(x = bw, ymin = mean_pH - se_pH,
                                             ymax = mean_pH + se_pH, color = Subject),
                width = 20, inherit.aes = F) +
  labs(x = "Birth weight (g)", y = "Fecal pH", color = "Participant") +
  geom_textbox(data = data.frame(x=1220, y = 7, label = "LMM<br>*p* = 0.0046"),
               aes(x, y, label = label), halign = 0.5, fill = NA, box.colour = NA,
               box.padding = grid::unit(rep(0, 4), "pt"), inherit.aes = F)


# Linear models - redox
pH_redox %>%
  lmer(redox ~ BGA + (1|Subject), data = .) %>%
  summary()
# BGA p = 0.060
# bw p = 0.17
# matabx p = 0.87

redox_BGA_plot <- ggplot(pH_redox, aes(x = BGA, y = redox, color = Subject)) +
  geom_point() +
  geom_errorbar(data = pH_redox_summary, aes(x = BGA, ymin = mean_redox,
                                             ymax = mean_redox, color = Subject),
                width = 0.5, inherit.aes = F) +
  geom_errorbar(data = pH_redox_summary, aes(x = BGA, ymin = mean_redox - se_redox,
                                             ymax = mean_redox + se_redox, color = Subject),
                width = 0.25, inherit.aes = F) +
  labs(x = "Birth gestational age (weeks)", y = "Fecal redox potential (mV)", color = "Participant") +
  geom_textbox(data = data.frame(x=33, y = -200, label = "LMM<br>*p* = 0.060"),
               aes(x, y, label = label), halign = 0.5, fill = NA, box.colour = NA,
               box.padding = grid::unit(rep(0, 4), "pt"), inherit.aes = F)

redox_bw_plot <- ggplot(pH_redox, aes(x = bw, y = redox, color = Subject)) +
  geom_point() +
  geom_errorbar(data = pH_redox_summary, aes(x = bw, ymin = mean_redox, ymax = mean_redox, color = Subject),
                width = 40, inherit.aes = F) +
  geom_errorbar(data = pH_redox_summary, aes(x = bw, ymin = mean_redox - se_redox,
                                             ymax = mean_redox + se_redox, color = Subject),
                width = 20, inherit.aes = F) +
  labs(x = "Birth weight (g)", y = "Fecal redox potential (mV)", color = "Participant") +
  geom_textbox(data = data.frame(x=1250, y = -350, label = "LMM<br>*p* = 0.17"),
               aes(x, y, label = label), halign = 0.5, fill = NA, box.colour = NA,
               box.padding = grid::unit(rep(0, 4), "pt"), inherit.aes = F)

# Test BGA-bw correlation
cor.test(pH_redox_summary$BGA, pH_redox_summary$bw, method = "spearman")
# p = 0.013, rho = 0.71

BGA_bw_plot <- ggplot(pH_redox_summary, aes(x = BGA, y = bw, color = Subject)) +
  geom_point() +
  labs(x = "Birth gestational age (weeks)", y = "Birth weight (g)", color = "Participant") +
  geom_textbox(data = data.frame(x=32.5, y = 900, label = "Spearman's &rho; = 0.71<br>*p* = 0.013"),
               aes(x, y, label = label), halign = 0.5, fill = NA, box.colour = NA,
               box.padding = grid::unit(rep(0, 4), "pt"), inherit.aes = F)

# pH and redox plot
pH_redox %>%
  lmer(redox ~ pH + (1|Subject), data = .) %>%
  summary()
# p = 0.13

pH_redox_plot <- ggplot(pH_redox, aes(x = pH, y = redox, color = Subject)) +
  geom_point() +
  labs(x = "Fecal pH", y = "Fecal redox potential (mV)", color = "Participant") +
  geom_textbox(data = data.frame(x=6.6, y = -400, label = "LMM<br>*p* = 0.13"),
               aes(x, y, label = label), halign = 0.5, fill = NA, box.colour = NA,
               box.padding = grid::unit(rep(0, 4), "pt"), inherit.aes = F)

```

## Analyze pH and redox in context of clinical data longitudinally
```{r}
pH_time_plot <- ggplot(pH_redox, aes(x = cga, y = pH, color = Subject)) +
  geom_point() +
  geom_line()

# LMM correcting for bw
pH_redox %>%
  lmer(redox ~ bw + DOL + (1 | Subject), data  = .) %>%
  summary()
# pH
## DOL p = 0.38
## Wt p = 0.61
## curr_Abx p = 0.94
# redox
## DOL p = 0.0045
## Wt p = 0.27
## curr_Abx p = 0.13

redox_DOL_plot <- ggplot(pH_redox, aes(x = DOL, y = redox, color = Subject)) +
  geom_point() +
  geom_line(alpha = 0.4) +
  labs(x = "Age (days)", y = "Fecal redox potential (mV)", color = "Participant") +
  geom_textbox(data = data.frame(x=18, y = -380, label = "LMM<br>*p* = 0.0045"),
               aes(x, y, label = label), halign = 0.5, fill = NA, box.colour = NA,
               box.padding = grid::unit(rep(0, 4), "pt"), inherit.aes = F)

pH_DOL_plot <- ggplot(pH_redox, aes(x = DOL, y = pH, color = Subject)) +
  geom_point() +
  geom_line(alpha = 0.4) +
  labs(x = "Age (days)", y = "Fecal pH", color = "Participant") +
  geom_textbox(data = data.frame(x=71, y = 6, label = "LMM<br>*p* = 0.38"),
               aes(x, y, label = label), halign = 0.5, fill = NA, box.colour = NA,
               box.padding = grid::unit(rep(0, 4), "pt"), inherit.aes = F)


```

# SCFA
## Analyze SCFA data in context of clinical data
```{r}
# Gather to make it easier to plot all SCFAs at once
scfa_gather <- pH_redox %>%
  gather(key = scfa, value = conc, acetate:total)

# lmm
scfa_lmm_results <- data.frame(scfa = rep(unique(scfa_gather$scfa), 5),
                               var = rep(c("BGA", "bw", "matabx", "pH", "redox"), each = 4),
                               p = NA)

for(r in 1:nrow(scfa_lmm_results)) {
  scfa_lmm_results$p[r] <- scfa_gather %>%
    filter(scfa == scfa_lmm_results$scfa[r]) %>%
    lmer(conc ~ get(scfa_lmm_results$var[r]) + (1|Subject), data = .) %>%
    summary() %>%
    .$coefficients %>%
    .[2,5]
}
# all NS except acetate-pH p = 0.0030 and totalSCFA-pH p = 0.0057


ace_pH_plot <- ggplot(pH_redox, aes(x = pH, y = acetate, color = Subject)) +
  geom_point() +
  labs(x = "Fecal pH", y = "Acetate concentration (mM)", color = "Participant") +
  geom_textbox(data = data.frame(x=6.8, y = 120, label = "LMM<br>*p* = 0.0030"),
               aes(x, y, label = label), halign = 0.5, fill = NA, box.colour = NA,
               box.padding = grid::unit(rep(0, 4), "pt"), inherit.aes = F)
  
  

```

## Assess relationship between SCFA and pH/redox
```{r}

```

# 16S
## Analyze 16S data in context of clinical data
```{r}
# Diversity

# NMDS


```

## Assess relationship between 16S and pH/redox
```{r}


```

# Patch figures
```{r}
# Fig. 1 - birth stats and pH/redox
fig1 <- plot_grid(pH_BGA_plot + theme(legend.position = "none"),
                  pH_bw_plot + theme(legend.position = "none"),
                  redox_BGA_plot + theme(legend.position = "none"),
                  redox_bw_plot+ theme(legend.position = "none"),
                  ncol = 2,
                  labels = c("A", "B", "C", "D"), label_fontface = "plain") %>%
  plot_grid(., get_legend(pH_BGA_plot), rel_widths = c(8,1))

# Fig. 2 - other variables pH and redox
redox_DOL_plot
pH_DOL_plot

# Fig. S1 
BGA_bw_plot
pH_redox_plot
ace_pH_plot

```

