---
title: "Infant fecal pH/redox analysis"
output: html_notebook
---

# Load libraries
```{r}
# Plotting
library(tidyverse)
#library(RColorBrewer)
library(ggtext)
library(ggsignif)
library(cowplot)

# Stats
library(phyloseq)
library(lme4)
library(lmerTest)
library(vegan)
library(ALDEx2)

theme_set(theme_bw() +
            theme(axis.text = element_text(color = "black"),
                  axis.ticks = element_line(color = "black"),
                  plot.title = element_text(hjust = 0.5)))

set.seed(123)


```

# Load and clean up data 
```{r}
# pH and redox with clinical data
## See data/variable_descriptions_for_fecal_pH_final.xlsx for explanations of variables
pH_redox <- read.csv("data/fecal_pH_final.csv")

# SCFA data by GC
## Isobutyrate, isovalerate, and valerate were not detected for any samples
## Two samples have been omitted where nothing was detected
## All values have been multiplied by 10 (dilution factor) and are in mM
## Where values were NA/0, they have been replaced with a pseudocount equal to the lowest value observed for that SCFA
gc <- read.csv("data/nicu_gc_cleaned.csv")

# Combine
pH_redox <- pH_redox %>%
  left_join(gc) %>%
  relocate(acetate:total, .after = redox)


```

## 16S
```{r}
# Load phyloseq object, omitting samples with < 5000 reads
## This version used to calculate diversity
ps <- readRDS("data/phyloseq.rds") %>%
  prune_samples(sample_sums(.) >= 5000, .)
# 95 taxa by 77 samples (none removed by filter)

# Omit low abundance taxa for differential abundance analysis
ps_filt <- ps %>%
  filter_taxa(function(x) sum(x > 3) > 0.1*length(x), TRUE)
# Reduces to 23 taxa (wow!)

```

# pH and redox
## Analyze pH and redox in context of clinical data - birth stats
```{r}
# Summarize pH and redox within infants
## Need to account for NA values in some cases
pH_redox_summary <- pH_redox %>%
  group_by(Subject, BGA, bw, matabx) %>%
  summarize(mean_pH = mean(pH, na.rm = T),
            se_pH = sd(pH, na.rm = T)/sqrt(length(which(!is.na(pH)))),
            mean_redox = mean(redox, na.rm = T),
            se_redox = sd(redox, na.rm = T)/sqrt(length(which(!is.na(redox)))))

# Linear models - pH
pH_redox %>%
  lmer(pH ~ matabx + (1|Subject), data = .) %>%
  summary()
# BGA p = 0.016
# bw p = 0.0046
# matabx p = 0.76

# Examine birth stats
pH_BGA_plot <- ggplot(pH_redox, aes(x = BGA, y = pH, color = Subject)) +
  geom_point() +
  geom_errorbar(data = pH_redox_summary, aes(x = BGA, ymin = mean_pH, ymax = mean_pH, color = Subject),
                width = 0.5, inherit.aes = F) +
  geom_errorbar(data = pH_redox_summary, aes(x = BGA, ymin = mean_pH - se_pH,
                                             ymax = mean_pH + se_pH, color = Subject),
                width = 0.25, inherit.aes = F) +
  labs(x = "Birth gestational age (weeks)", y = "Fecal pH", color = "Participant") +
  geom_textbox(data = data.frame(x=33, y = 7, label = "Linear mixed model<br>pH ~ BGA + (1 | Subject)<br>BGA *p* = 0.016"),
               aes(x, y, label = label), halign = 0.5, fill = NA, box.colour = NA,
               box.padding = grid::unit(rep(0, 4), "pt"), inherit.aes = F)

pH_bw_plot <- ggplot(pH_redox, aes(x = bw, y = pH, color = Subject)) +
  geom_point() +
  geom_errorbar(data = pH_redox_summary, aes(x = bw, ymin = mean_pH, ymax = mean_pH, color = Subject),
                width = 40, inherit.aes = F) +
  geom_errorbar(data = pH_redox_summary, aes(x = bw, ymin = mean_pH - se_pH,
                                             ymax = mean_pH + se_pH, color = Subject),
                width = 20, inherit.aes = F) +
  labs(x = "Birth weight (g)", y = "Fecal pH", color = "Participant") +
  geom_textbox(data = data.frame(x=1220, y = 7, label = "Linear mixed model<br>pH ~ bw + (1 | Subject)<br>bw *p* = 0.0046"),
               aes(x, y, label = label), halign = 0.5, fill = NA, box.colour = NA,
               box.padding = grid::unit(rep(0, 4), "pt"), inherit.aes = F)


# Linear models - redox
pH_redox %>%
  lmer(redox ~ BGA + (1|Subject), data = .) %>%
  summary()
# BGA p = 0.060
# bw p = 0.17
# matabx p = 0.87

redox_BGA_plot <- ggplot(pH_redox, aes(x = BGA, y = redox, color = Subject)) +
  geom_point() +
  geom_errorbar(data = pH_redox_summary, aes(x = BGA, ymin = mean_redox,
                                             ymax = mean_redox, color = Subject),
                width = 0.5, inherit.aes = F) +
  geom_errorbar(data = pH_redox_summary, aes(x = BGA, ymin = mean_redox - se_redox,
                                             ymax = mean_redox + se_redox, color = Subject),
                width = 0.25, inherit.aes = F) +
  labs(x = "Birth gestational age (weeks)", y = "Fecal redox potential (mV)", color = "Participant") +
  geom_textbox(data = data.frame(x=32.5, y = -400, label = "Linear mixed model<br>redox ~ BGA + (1 | Subject)<br>BGA *p* = 0.060"),
               aes(x, y, label = label), halign = 0.5, fill = NA, box.colour = NA,
               box.padding = grid::unit(rep(0, 4), "pt"), inherit.aes = F)

redox_bw_plot <- ggplot(pH_redox, aes(x = bw, y = redox, color = Subject)) +
  geom_point() +
  geom_errorbar(data = pH_redox_summary, aes(x = bw, ymin = mean_redox, ymax = mean_redox, color = Subject),
                width = 40, inherit.aes = F) +
  geom_errorbar(data = pH_redox_summary, aes(x = bw, ymin = mean_redox - se_redox,
                                             ymax = mean_redox + se_redox, color = Subject),
                width = 20, inherit.aes = F) +
  labs(x = "Birth weight (g)", y = "Fecal redox potential (mV)", color = "Participant") +
  geom_textbox(data = data.frame(x=1225, y = -420, label = "Linear mixed model<br>redox ~ bw + (1 | Subject)<br>bw *p* = 0.17"),
               aes(x, y, label = label), halign = 0.5, fill = NA, box.colour = NA,
               box.padding = grid::unit(rep(0, 4), "pt"), inherit.aes = F)

# Test BGA-bw correlation
## Doing correlation because I actually only have 11 points here, no longitudinal sampling
cor.test(pH_redox_summary$BGA, pH_redox_summary$bw, method = "spearman")
# p = 0.013, rho = 0.71

BGA_bw_plot <- ggplot(pH_redox_summary, aes(x = BGA, y = bw, color = Subject)) +
  geom_point() +
  labs(x = "Birth gestational age (weeks)", y = "Birth weight (g)", color = "Participant") +
  geom_textbox(data = data.frame(x=32.5, y = 900, label = "Spearman's &rho; = 0.71<br>*p* = 0.013"),
               aes(x, y, label = label), halign = 0.5, fill = NA, box.colour = NA,
               box.padding = grid::unit(rep(0, 4), "pt"), inherit.aes = F)

# pH and redox plot
pH_redox %>%
  lmer(redox ~ pH + (1|Subject), data = .) %>%
  summary()
# p = 0.13

pH_redox_plot <- ggplot(pH_redox, aes(x = pH, y = redox, color = Subject)) +
  geom_point() +
  labs(x = "Fecal pH", y = "Fecal redox potential (mV)", color = "Participant") +
  geom_textbox(data = data.frame(x=6.6, y = -400, label = "Linear mixed model<br>redox ~ pH + (1 | Subject)<br>pH *p* = 0.13"),
               aes(x, y, label = label), halign = 0.5, fill = NA, box.colour = NA,
               box.padding = grid::unit(rep(0, 4), "pt"), inherit.aes = F)

```

## Analyze pH and redox in context of clinical data longitudinally
```{r}
pH_time_plot <- ggplot(pH_redox, aes(x = cga, y = pH, color = Subject)) +
  geom_point() +
  geom_line()

# LMM correcting for bw
pH_redox %>%
  lmer(redox ~ bw + DOL + (1 | Subject), data  = .) %>%
  summary()
# pH
## DOL p = 0.38
## Wt p = 0.61
# redox
## DOL p = 0.0045
## Wt p = 0.27

redox_DOL_plot <- ggplot(pH_redox, aes(x = DOL, y = redox, color = Subject)) +
  geom_point() +
  geom_line(alpha = 0.4) +
  labs(x = "Age (days)", y = "Fecal redox potential (mV)", color = "Participant") +
  geom_textbox(data = data.frame(x = 60, y = -475, label = "Linear mixed model<br>redox ~ bw + DOL + (1 | Subject)<br>DOL *p* = 0.0045"),
               aes(x, y, label = label), halign = 0.5, fill = NA, box.colour = NA,
               box.padding = grid::unit(rep(0, 4), "pt"), width = unit(3, "inch"), inherit.aes = F)

pH_DOL_plot <- ggplot(pH_redox, aes(x = DOL, y = pH, color = Subject)) +
  geom_point() +
  geom_line(alpha = 0.4) +
  labs(x = "Age (days)", y = "Fecal pH", color = "Participant") +
  geom_textbox(data = data.frame(x = 64, y = 5.42, label = "Linear mixed model<br>pH ~ bw + DOL + (1 | Subject)<br>DOL *p* = 0.38"),
               aes(x, y, label = label), halign = 0.5, fill = NA, box.colour = NA,
               box.padding = grid::unit(rep(0, 4), "pt"), width = unit(3, "inch"), inherit.aes = F)


```

# SCFA
## Analyze SCFA data in context of clinical data
```{r}
# Gather to make it easier to plot all SCFAs at once
scfa_gather <- pH_redox %>%
  gather(key = scfa, value = conc, acetate:total)

# lmm
scfa_lmm_results <- data.frame(scfa = rep(unique(scfa_gather$scfa), 6),
                               var = rep(c("BGA", "bw", "pH", "redox", "DOL", "Wt"), each = 4),
                               p = NA)

for(r in 1:nrow(scfa_lmm_results)) {
  
  # For longitudinal variables (DOL, Wt), control for birth weight
  if(scfa_lmm_results$var[r] %in% c("DOL", "Wt", "feedintol")) {
    scfa_lmm_results$p[r] <- scfa_gather %>%
      filter(scfa == scfa_lmm_results$scfa[r]) %>%
      lmer(conc ~ bw + get(scfa_lmm_results$var[r]) + (1|Subject), data = .) %>%
      summary() %>%
      .$coefficients %>%
      .[3,5]
      
  } else {
    scfa_lmm_results$p[r] <- scfa_gather %>%
      filter(scfa == scfa_lmm_results$scfa[r]) %>%
      lmer(conc ~ get(scfa_lmm_results$var[r]) + (1|Subject), data = .) %>%
      summary() %>%
      .$coefficients %>%
      .[2,5]
  }

}
# all NS except:
## total ~ pH p = 0.0057, and acetate ~ pH p = 0.0030
## total ~ bw + DOL p = 0.024, and acetate ~ bw + DOL p = 0.029
## propionate ~ bw + DOL p = 0.031, and propionate ~ bw + Wt p = 0.00047

# Total/ace and pH
total_pH_plot <- ggplot(pH_redox, aes(x = pH, y = total, color = Subject)) +
  geom_point() +
  labs(x = "Fecal pH", y = "Total SCFA concentration (mM)", color = "Participant") +
  geom_textbox(data = data.frame(x=6.8, y = 120, label = "Linear mixed model<br>total ~ pH + (1 | Subject)<br>pH *p* = 0.0057"),
               aes(x, y, label = label), halign = 0.5, fill = NA, box.colour = NA,
               box.padding = grid::unit(rep(0, 4), "pt"), inherit.aes = F)

ace_pH_plot <- ggplot(pH_redox, aes(x = pH, y = acetate, color = Subject)) +
  geom_point() +
  labs(x = "Fecal pH", y = "Acetate concentration (mM)", color = "Participant") +
  geom_textbox(data = data.frame(x=6.8, y = 120, label = "Linear mixed model<br>acetate ~ pH + (1 | Subject)<br>pH *p* = 0.0030"),
               aes(x, y, label = label), halign = 0.5, fill = NA, box.colour = NA,
               box.padding = grid::unit(rep(0, 4), "pt"), inherit.aes = F)
  
# Total/ace and DOL
total_DOL_plot <- ggplot(pH_redox, aes(x = DOL, y = total, color = Subject)) +
  geom_point() +
  geom_line(alpha = 0.4) +
  labs(x = "Age (days)", y = "Total SCFA concentration (mM)", color = "Participant") +
  geom_textbox(data = data.frame(x = 60, y = 175, label = "Linear mixed model<br>total ~ bw + DOL + (1 | Subject)<br>DOL *p* = 0.024"),
               aes(x, y, label = label), halign = 0.5, fill = NA, box.colour = NA,
               box.padding = grid::unit(rep(0, 4), "pt"), width = unit(3, "inch"), inherit.aes = F)

ace_DOL_plot <- ggplot(pH_redox, aes(x = DOL, y = acetate, color = Subject)) +
  geom_point() +
  geom_line(alpha = 0.4) +
  labs(x = "Age (days)", y = "Acetate concentration (mM)", color = "Participant") +
  geom_textbox(data = data.frame(x = 60, y = 130, label = "Linear mixed model<br>acetate ~ bw + DOL + (1 | Subject)<br>DOL *p* = 0.029"),
               aes(x, y, label = label), halign = 0.5, fill = NA, box.colour = NA,
               box.padding = grid::unit(rep(0, 4), "pt"), width = unit(3, "inch"), inherit.aes = F)

# Propionate and DOL / Wt
pro_DOL_plot <- ggplot(pH_redox, aes(x = DOL, y = propionate, color = Subject)) +
  geom_point() +
  geom_line(alpha = 0.4) +
  labs(x = "Age (days)", y = "Propionate concentration (mM)", color = "Participant") +
  geom_textbox(data = data.frame(x = 58, y = 20, label = "Linear mixed model<br>propionate ~ bw + DOL + (1 | Subject)<br>DOL *p* = 0.031"),
               aes(x, y, label = label), halign = 0.5, fill = NA, box.colour = NA,
               box.padding = grid::unit(rep(0, 4), "pt"), width = unit(3, "inch"), inherit.aes = F)

pro_Wt_plot <- ggplot(pH_redox, aes(x = Wt, y = propionate, color = Subject)) +
  geom_point() +
  geom_line(alpha = 0.4) +
  labs(x = "Weight (g)", y = "Propionate concentration (mM)", color = "Participant") +
  geom_textbox(data = data.frame(x = 1200, y = 20, label = "Linear mixed model<br>propionate ~ bw + Wt + (1 | Subject)<br>Wt *p* = 0.00047"),
               aes(x, y, label = label), halign = 0.5, fill = NA, box.colour = NA,
               box.padding = grid::unit(rep(0, 4), "pt"), width = unit(3, "inch"), inherit.aes = F)
  

```

# 16S
## Analyze 16S data in context of clinical data
```{r}
# Diversity
diversity <- ps %>%
  estimate_richness(split = TRUE, measures = c("Shannon", "Observed")) %>%
  cbind(ps@sam_data) %>%
  gather(key = measure, value = value, c("Shannon", "Observed"))

diversity_summary <- diversity %>%
  group_by(Subject_ID, bw, BGA, measure) %>%
  summarize(mean = mean(value, na.rm = T),
            se = sd(value, na.rm = T)/sqrt(length(which(!is.na(value)))))

## lmer
diversity %>%
  filter(measure == "Shannon") %>%
  lmer(value ~ bw + DOL + (1 | Subject_ID), data = .) %>%
  summary()
# Shannon bw = 0.61, BGA = 0.23
# Observed bw = 0.75, BGA = 0.50
# Shannon bw + DOL p = 9.06e-06
# Observed bw + DOL p = 0.025

## Diversity plot
diversity_bw_plot <- ggplot(diversity, aes(x = bw, y = value, color = Subject_ID)) +
  geom_point() +
  geom_errorbar(data = diversity_summary, aes(x = bw, ymin = mean, ymax = mean, color = Subject_ID),
                width = 40, inherit.aes = F) +
  geom_errorbar(data = diversity_summary, aes(x = bw, ymin = mean - se,
                                             ymax = mean + se, color = Subject_ID),
                width = 20, inherit.aes = F) +
  facet_wrap(~measure, scales = "free_y") +
  labs(x = "Birth weight (g)", y = "Alpha diversity", color = "Participant") +
  geom_textbox(data = data.frame(x = c(1100, 1200), y = c(23, 0.55),
                                 measure = c("Observed", "Shannon"),
                                 label = c("Linear mixed model<br>observed ~ bw + (1 | Subject)<br>bw *p* = 0.75", "Linear mixed model<br>Shannon ~ bw + (1 | Subject)<br>bw *p* = 0.61")),
               aes(x, y, label = label), halign = 0.5, fill = NA, box.colour = NA,
               box.padding = grid::unit(rep(0, 4), "pt"), width = unit(3, "inch"), inherit.aes = F)
  

diversity_DOL_plot <- ggplot(diversity, aes(x = DOL, y = value,
                                            color = Subject_ID, group = Subject_ID)) +
  geom_point() +
  geom_line(alpha = 0.4) +
  facet_wrap(~measure, scales = "free_y") +
  labs(x = "Age (days)", y = "Alpha diversity", color = "Participant") +
  geom_textbox(data = data.frame(x = c(50, 60), y = c(23, 0.15),
                                 measure = c("Observed", "Shannon"),
                                 label = c("Linear mixed model<br>observed ~ bw + DOL + (1 | Subject)<br>DOL *p* = 0.025", "Linear mixed model<br>Shannon ~ bw + DOL + (1 | Subject)<br>DOL *p* = 9.1 x 10<sup>-6</sup>")),
               aes(x, y, label = label), halign = 0.5, fill = NA, box.colour = NA,
               box.padding = grid::unit(rep(0, 4), "pt"), width = unit(3, "inch"), inherit.aes = F)

# NMDS


```

## Assess relationship between 16S and pH/redox
```{r}


```


# Can we predict feed intolerance with random forest?
```{r}

```


# Patch figures
```{r}
# Fig. 1 - birth stats and pH/redox
fig1 <- plot_grid(pH_bw_plot + theme(legend.position = "none"),
                  redox_bw_plot + theme(legend.position = "none"),
                  pH_BGA_plot + theme(legend.position = "none"),
                  redox_BGA_plot + theme(legend.position = "none"),
                  pH_DOL_plot + theme(legend.position = "none"),
                  redox_DOL_plot + theme(legend.position = "none"),
                  ncol = 2,
                  labels = c("A", "B", "C", "D", "E", "F"), label_fontface = "plain") %>%
  plot_grid(., get_legend(pH_BGA_plot), rel_widths = c(8,1))
#ggsave("plots/fig1.png", fig1, height = 10, width = 10)

# Fig. 2 - SCFA
fig2 <- plot_grid(total_pH_plot + theme(legend.position = "none"),
                  ace_pH_plot + theme(legend.position = "none"),
                  total_DOL_plot + theme(legend.position = "none"),
                  ace_DOL_plot + theme(legend.position = "none"),
                  pro_DOL_plot + theme(legend.position = "none"),
                  pro_Wt_plot + theme(legend.position = "none"),
                  ncol = 2,
                  labels = c("A", "B", "C", "D", "E", "F"), label_fontface = "plain") %>%
  plot_grid(., get_legend(total_pH_plot), rel_widths = c(8,1))
#ggsave("plots/fig2.png", fig2, height = 10, width = 10)

# Fig. 3 16S

# Fig. 4 random forest?


# Fig. S1 
BGA_bw_plot
pH_redox_plot

# Fig. S2
diversity_bw_plot
diversity_DOL_plot




```